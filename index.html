<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>777 æ‹‰éœ¸æŠ½ç±¤ï¼ˆè‡ªæˆ‘æ’é™¤ï¼‹ä¸é‡è¤‡ï¼‰</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panel:#111a2d;
      --panel2:#0f1730;
      --gold:#f6d365;
      --gold2:#fda085;
      --txt:#f3f6ff;
      --muted:#aab3cc;
      --danger:#ff5a7a;
      --ok:#33d17a;
      --font: 22px;
      --font-big: 34px;
      --r:18px;
    }
    body{
      margin:16px;
      font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",system-ui,"Segoe UI",Arial;
      background: radial-gradient(1200px 800px at 20% 10%, #1a2a6c33, transparent 55%),
                  radial-gradient(1000px 700px at 90% 20%, #b21f1f22, transparent 55%),
                  radial-gradient(1200px 800px at 50% 90%, #fdbb2d22, transparent 55%),
                  var(--bg);
      color:var(--txt);
      font-size:var(--font);
      line-height:1.45;
      -webkit-text-size-adjust: 100%;
    }

    /* âœ…ã€æ–°å¢ã€‘æ‹‰æ¡¿æœŸé–“é–å®šæ•´å€‹é é¢ï¼ˆiPhone é˜²èª¤æ»‘ + æ”¾æ‰‹å›åŸä½ï¼‰ */
    body.lock-scroll{
      position: fixed;
      width: 100%;
      overflow: hidden;
      left: 0; right: 0;
    }

    h1{ margin:0 0 10px; font-size:28px; letter-spacing:.5px; }
    .muted{ color:var(--muted); font-size:18px; }
    .card{
      background: linear-gradient(180deg, #121b33, #0d1326);
      border: 1px solid #22305a;
      border-radius: var(--r);
      padding:16px;
      margin:14px 0;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .row{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:10px 14px;
      border-radius: 999px;
      border:1px solid #2a3a6d;
      background: #0b1227;
      font-size:20px;
    }
    .big{ font-size:var(--font-big); font-weight:900; letter-spacing:.5px; }
    button{
      font-size:22px;
      padding:14px 18px;
      border-radius: 16px;
      border:2px solid #ffffff22;
      background: linear-gradient(180deg, #23315c, #17234a);
      color:var(--txt);
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
    }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    /* Pick-me list */
    .radioList{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }
    .radioItem{
      display:flex; align-items:center; gap:14px;
      padding:14px;
      border-radius: 16px;
      border: 1px solid #2a3a6d;
      background: #0b1227;
    }
    .radioItem input[type="radio"]{ width:28px; height:28px; }
    .radioItem b{ font-size:24px; }

    /* SLOT MACHINE */
    .machine{
      width: min(980px, 100%);
      margin: 0 auto;
      border-radius: 26px;
      background: linear-gradient(180deg, #1b2a57, #101a36);
      border: 2px solid #2a3a6d;
      box-shadow: 0 30px 70px rgba(0,0,0,.55);
      overflow:hidden;
      position: relative;
    }
    .marquee{
      display:flex; align-items:center; justify-content:center;
      padding:12px 14px;
      background: linear-gradient(90deg, #f6d365, #fda085);
      color:#1a1230;
      font-weight: 1000;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-size: 22px;
      position:relative;
    }
    .marquee .dots{
      margin-left:10px;
      font-weight:900;
      letter-spacing: 8px;
    }
    /* WIN ç‡ˆç‰Œ */
    .winBadge{
      position:absolute;
      right:12px; top:8px;
      padding:6px 10px;
      border-radius: 999px;
      border: 2px solid #1a123055;
      background: rgba(255,255,255,.22);
      font-weight: 1000;
      letter-spacing: 2px;
      display:none;
      user-select:none;
    }
    .winOn .winBadge{
      display:inline-flex;
      animation: badgeBlink .7s infinite alternate;
    }
    @keyframes badgeBlink{
      from{ transform: translateY(0); filter: brightness(1); }
      to{ transform: translateY(-1px); filter: brightness(1.5); }
    }

    .machineBody{
      padding: 16px;
      display:grid;
      grid-template-columns: 1fr 170px;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 820px){
      .machineBody{ grid-template-columns: 1fr; }
    }

    .reelsWrap{
      background: linear-gradient(180deg, #0d1326, #0a1022);
      border: 1px solid #24335f;
      border-radius: 22px;
      padding: 16px;
      position:relative;
      overflow:hidden;
    }

    .reels{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      align-items: stretch;
    }
    .reel{
      height: 160px;
      border-radius: 18px;
      border: 2px solid #2a3a6d;
      background: linear-gradient(180deg, #0b1227, #070b18);
      position: relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.03);
    }
    .reel::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.18), transparent 30%, transparent 70%, rgba(0,0,0,.35));
      pointer-events:none;
    }
    .window{
      position:absolute;
      left:10px; right:10px;
      top:50%; transform: translateY(-50%);
      height: 68px;
      border-radius: 14px;
      border: 2px solid #ffffff22;
      background: rgba(255,255,255,.06);
      box-shadow: 0 0 0 2px rgba(0,0,0,.25) inset;
      pointer-events:none;
    }
    .reelText{
      font-size: 34px;
      font-weight: 1000;
      letter-spacing: .8px;
      text-shadow: 0 3px 0 rgba(0,0,0,.35);
    }
    .glow{
      position:absolute; inset:-30px;
      background: radial-gradient(closest-side, rgba(253,160,133,.20), transparent 60%);
      opacity: .0;
      transition: opacity .25s ease;
      pointer-events:none;
    }
    .spinning .glow{ opacity: .9; }

    .statusBar{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .resultBox{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid #2a3a6d;
      background: #0b1227;
      padding: 14px;
      position:relative;
    }
    .ok{ color: var(--ok); }
    .danger{ color: var(--danger); }

    /* ğŸ‡ çˆ†é–ƒ overlay */
    .flashOverlay{
      position:absolute;
      inset:-40px;
      pointer-events:none;
      opacity:0;
      background:
        radial-gradient(circle at 30% 30%, rgba(246,211,101,.45), transparent 45%),
        radial-gradient(circle at 70% 40%, rgba(253,160,133,.35), transparent 45%),
        radial-gradient(circle at 50% 70%, rgba(255,255,255,.18), transparent 55%);
      filter: blur(0px);
    }
    .winFlash .flashOverlay{
      animation: flash 900ms ease-out 1;
    }
    @keyframes flash{
      0%   { opacity:0; transform: scale(0.9); }
      20%  { opacity:1; transform: scale(1.02); }
      60%  { opacity:.75; transform: scale(1.05); }
      100% { opacity:0; transform: scale(1.10); }
    }
    .winFlash .reel{
      animation: reelPulse 900ms ease-out 1;
    }
    @keyframes reelPulse{
      0%   { box-shadow: inset 0 0 0 2px rgba(255,255,255,.03); filter: brightness(1); }
      25%  { box-shadow: 0 0 0 3px rgba(246,211,101,.35), 0 0 30px rgba(253,160,133,.28); filter: brightness(1.25); }
      100% { box-shadow: inset 0 0 0 2px rgba(255,255,255,.03); filter: brightness(1); }
    }

    /* Lever */
    .leverPanel{
      border-radius: 22px;
      border: 1px solid #24335f;
      background: linear-gradient(180deg, #0b1227, #070b18);
      padding: 16px;
      position: relative;
      min-height: 320px;
    }
    .leverTitle{ font-weight: 1000; letter-spacing: 1px; }
    .leverHint{ color:var(--muted); font-size: 18px; margin-top:6px; }
    .leverTrack{
      margin-top: 14px;
      height: 210px;
      border-radius: 999px;
      background: linear-gradient(180deg, #16244a, #0a1022);
      border: 2px solid #2a3a6d;
      position: relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .leverFill{
      position:absolute; left:0; right:0; bottom:0;
      height: 0%;
      background: linear-gradient(180deg, #f6d365, #fda085);
      opacity: .85;
      transition: height .04s linear;
    }
    .leverKnob{
      width: 88px; height: 88px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #f6d365 30%, #fda085 70%, #c94a2f);
      border: 3px solid #ffffff33;
      box-shadow: 0 18px 30px rgba(0,0,0,.55);
      position:absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
    }
    .leverKnob::after{
      content:"";
      position:absolute; inset:10px;
      border-radius: 50%;
      background: rgba(255,255,255,.22);
    }
    .leverLine{
      position:absolute;
      top: 0; bottom: 0;
      left: 50%;
      width: 6px;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #ffffff22, #00000055);
      border-radius: 999px;
    }

    .smallBoxes{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .smallBoxes{ grid-template-columns: 1fr; }
    }
    .listBox{
      max-height: 220px;
      overflow:auto;
      border: 1px solid #2a3a6d;
      border-radius: 18px;
      padding: 10px 14px;
      background: #0b1227;
    }
    .listBox div{ padding: 7px 0; border-bottom: 1px dashed #2a3a6d; }
    .listBox div:last-child{ border-bottom:0; }

    /* âœ… iPhone æ‹‰æ¡¿é«”é©—ä¿®æ­£ */
    .leverTrack,
    .leverKnob{
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
/* =========================
   ğŸ“± iPhone UX æœ€å¾Œ 5% å¾®èª¿
   ========================= */
@media (max-width: 480px){

  body{
    margin: 8px;
  }

  /* æ•´å°æ©Ÿå™¨é™åˆ¶åœ¨è¢å¹•å…§ï¼ˆiOS å®‰å…¨é«˜åº¦ï¼‰ */
  .machine{
    max-height: 100svh;
  }

  .machineBody{
    gap: 10px;
  }

  /* ğŸ° Reel æ‹‰éœ¸ï¼šç¸®é«˜ä¸ç¸®æ„Ÿè¦º */
  .reel{
    height: 120px;        /* åŸ 160 */
  }

  .reelText{
    font-size: 28px;      /* åŸ 34 */
  }

  .window{
    height: 56px;
  }

  /* ğŸ“¦ çµæœå€å¡Šå£“ç¸®ä¸€é» */
  .resultBox{
    padding: 12px;
  }

  /* ğŸ•¹ æ‹‰æ¡¿å€ï¼šä¸è¦æ’çˆ†ç•«é¢ */
  .leverPanel{
    min-height: auto;     /* é—œéµ */
    padding: 12px;
  }

  .leverTrack{
    height: 180px;        /* åŸ 210 */
  }

  .leverKnob{
    width: 72px;
    height: 72px;
  }

  /* å°åˆ—è¡¨åœ¨ iPhone ä¸æ¶ç©ºé–“ */
  .smallBoxes{
    gap: 8px;
  }

  .listBox{
    max-height: 160px;
  }
}

  </style>
</head>

<body>
  <h1>ğŸ° 777 æ‹‰éœ¸æŠ½ç±¤ï¼ˆæ’é™¤æˆ‘è‡ªå·±ï¼‹å·²æŠ½éï¼‰</h1>
  <div class="muted">å…ˆé¸ã€Œæˆ‘æ˜¯èª°ã€â†’ é–‹å§‹ â†’ æ¯æ¬¡æ‹‰æ¡¿æŠ½ 1 äººï¼ŒæŠ½åˆ°å°±ç§»é™¤ï¼Œä¸é‡è¤‡ã€‚</div>

  <!-- STEP 1 -->
  <div class="card" id="stepPickMe">
    <div class="big">1) ä½ æ˜¯èª°ï¼Ÿï¼ˆå–®é¸ï¼‰</div>
    <div class="radioList" id="radioList"></div>
    <div class="row" style="margin-top:14px;">
      <button id="btnStart" disabled>é–‹å§‹ï¼ˆæ’é™¤æˆ‘è‡ªå·±ï¼‰</button>
      <span class="muted" id="pickHint">è«‹å…ˆé¸ä¸€å€‹äººå</span>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="card" id="stepDraw" style="display:none;">
    <div class="row">
      <span class="pill">æˆ‘è‡ªå·±ï¼š<b id="meName">â€”</b>ï¼ˆå·²æ’é™¤ï¼‰</span>
      <span class="pill">å‰©é¤˜ï¼š<b id="remainCount">0</b> äºº</span>
      <span class="pill">ç‹€æ…‹ï¼š<b id="stateText">å¾…æŠ½</b></span>
    </div>

    <div class="machine" style="margin-top:14px;">
      <div class="marquee" id="marquee">
        777 LUCKY DRAW <span class="dots">â— â— â—</span>
        <span class="winBadge">WIN</span>
      </div>

      <div class="machineBody">
        <!-- Reels -->
        <div class="reelsWrap" id="reelsWrap">
          <div class="flashOverlay"></div>

          <div class="reels">
            <div class="reel">
              <div class="glow"></div>
              <div class="window"></div>
              <div class="reelText" id="reel1">â€”</div>
            </div>
            <div class="reel">
              <div class="glow"></div>
              <div class="window"></div>
              <div class="reelText" id="reel2">â€”</div>
            </div>
            <div class="reel">
              <div class="glow"></div>
              <div class="window"></div>
              <div class="reelText" id="reel3">â€”</div>
            </div>
          </div>

          <div class="resultBox">
            <div class="big" id="result">æ‹‰æ¡¿é–‹å§‹æŠ½</div>
            <div class="muted" id="status">æç¤ºï¼šæŠŠå³é‚Šæ‹‰æ¡¿å¾€ä¸‹æ‹‰åˆ°åº•ï¼Œæ”¾é–‹å³å¯æŠ½ã€‚</div>
          </div>

          <div class="statusBar">
            <button id="btnResetAll" style="border-color:#ffffff22;">å…¨éƒ¨é‡ä¾†</button>
            <div class="muted">ï¼ˆRAND æŠ½ç±¤ï¼šæ¯æ¬¡åœ¨å‰©é¤˜åå–®ä¸­å…¬å¹³éš¨æ©Ÿï¼‰</div>
          </div>
        </div>

        <!-- Lever -->
        <div class="leverPanel">
          <div class="leverTitle">æ‹‰æ¡¿</div>
          <div class="leverHint">å¾€ä¸‹æ‹‰åˆ°åº• â†’ æ”¾é–‹æŠ½ï¼ˆiPhone å‹å–„ï¼‰</div>

          <div class="leverTrack" id="leverTrack">
            <div class="leverFill" id="leverFill"></div>
            <div class="leverLine"></div>
            <div class="leverKnob" id="leverKnob" aria-label="lever"></div>
          </div>

          <div class="row" style="margin-top:12px;">
            <!-- âœ…ã€æ”¹ã€‘é–‹å§‹å‰ä¸èƒ½æŠ½ -->
            <button id="btnPull" style="width:100%;" disabled>æˆ‘æ‡¶å¾—æ‹‰ï¼šç›´æ¥æŠ½</button>
          </div>

          <div class="muted" style="margin-top:10px;">
            å°æç¤ºï¼šæ•´æ¢æ‹‰æ¡¿å€åŸŸéƒ½èƒ½æ‹–æ‹‰ï¼ˆä¸ç”¨æ­»æŠ“åœ“çƒï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>

    <div class="smallBoxes">
      <div>
        <div style="font-weight:1000; margin-bottom:8px;">å·²æŠ½é †åº</div>
        <div class="listBox" id="historyBox"></div>
      </div>
      <div>
        <div style="font-weight:1000; margin-bottom:8px;">å·²æ’é™¤åå–®ï¼ˆå«æˆ‘è‡ªå·±ï¼‹å·²æŠ½éï¼‰</div>
        <div class="listBox" id="excludedBox"></div>
      </div>
    </div>
  </div>

<script>
  // ===== åå–®ï¼ˆåªæ”¹é€™è£¡ï¼‰=====
  const ALL_NAMES = ["ç‰","å†°","éˆ","ç´…","è‘‰","ç™½","åº•","è±†","å®","7","å¤§é›„","Allen"];

  // ===== State =====
  let me = null;
  let remaining = [];
  let excluded = new Set();
  let history = [];
  let busy = false;

  // âœ…ã€æ–°å¢ã€‘åªæŠŠã€Œé–‹å§‹é¸çš„é‚£å€‹äºº(me)ã€åŠ å›ä¸€æ¬¡ï¼ˆåœ¨ç¬¬2è¼ªé–‹å§‹å‰ï¼‰
  let meRestored = false;

  // ===== Elements =====
  const radioList = document.getElementById("radioList");
  const btnStart = document.getElementById("btnStart");
  const pickHint = document.getElementById("pickHint");

  const stepPickMe = document.getElementById("stepPickMe");
  const stepDraw = document.getElementById("stepDraw");

  const meName = document.getElementById("meName");
  const remainCount = document.getElementById("remainCount");
  const stateText = document.getElementById("stateText");

  const reelsWrap = document.getElementById("reelsWrap");
  const marquee = document.getElementById("marquee");
  const reel1 = document.getElementById("reel1");
  const reel2 = document.getElementById("reel2");
  const reel3 = document.getElementById("reel3");

  const result = document.getElementById("result");
  const status = document.getElementById("status");

  const historyBox = document.getElementById("historyBox");
  const excludedBox = document.getElementById("excludedBox");

  const btnResetAll = document.getElementById("btnResetAll");
  const btnPull = document.getElementById("btnPull");

  const leverTrack = document.getElementById("leverTrack");
  const leverKnob = document.getElementById("leverKnob");
  const leverFill = document.getElementById("leverFill");

  // ===== ğŸ”’ Page Scroll Lockï¼ˆæ‹‰æ¡¿æœŸé–“é–é ï¼Œæ”¾æ‰‹å›åŸä½ï¼‰ =====
  let _scrollY = 0;
  function lockScroll(){
    _scrollY = window.scrollY || document.documentElement.scrollTop || 0;
    document.body.classList.add("lock-scroll");
    document.body.style.top = `-${_scrollY}px`;
  }
  function unlockScroll(){
    document.body.classList.remove("lock-scroll");
    document.body.style.top = "";
    window.scrollTo(0, _scrollY);
  }

  // ===== Crypto RNG helper (æ›´ç©©çš„ RAND) =====
  function randInt(maxExclusive){
    if (maxExclusive <= 0) return 0;
    const a = new Uint32Array(1);
    crypto.getRandomValues(a);
    return a[0] % maxExclusive;
  }

  // ===== ğŸ“³ Haptics (best-effort) =====
  function haptic(pattern){
    try{
      if (navigator.vibrate) navigator.vibrate(pattern);
    }catch(e){}
  }

  // ===== ğŸ”Š WebAudio SFX (ä¸éœ€å¤–éƒ¨æª”æ¡ˆ) =====
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
      audioCtx.resume();
    }
  }

  function playTone(freq=440, dur=0.08, type="sine", gain=0.08){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(gain, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.connect(g).connect(audioCtx.destination);
    o.start(t);
    o.stop(t+dur+0.02);
  }

  function playPullSfx(){
    if(!audioCtx) return;
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "triangle";
    o.frequency.setValueAtTime(820, t);
    o.frequency.exponentialRampToValueAtTime(180, t + 0.16);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.10, t+0.015);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.18);
    o.connect(g).connect(audioCtx.destination);
    o.start(t);
    o.stop(t+0.20);
  }

  function playStopSfx(which){
    const freqs = [520, 420, 320];
    playTone(freqs[which] || 360, 0.06, "square", 0.06);
  }

  function playWinSfx(){
    playTone(523.25, 0.08, "sine", 0.08); // C5
    setTimeout(()=>playTone(659.25, 0.08, "sine", 0.08), 90);  // E5
    setTimeout(()=>playTone(783.99, 0.10, "sine", 0.09), 180); // G5
  }

  // ===== UI =====
  function renderPickMe(){
    radioList.innerHTML = "";
    ALL_NAMES.forEach((name, idx) => {
      const label = document.createElement("label");
      label.className = "radioItem";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = "me";
      input.value = name;
      input.id = "me_" + idx;

      input.addEventListener("change", () => {
        me = name;
        btnStart.disabled = false;
        pickHint.textContent = `å·²é¸ï¼š${me}`;
        pickHint.className = "muted";
        ensureAudio();
        playTone(440, 0.05, "sine", 0.05);
      });

      const text = document.createElement("b");
      text.textContent = name;

      label.appendChild(input);
      label.appendChild(text);
      radioList.appendChild(label);
    });
  }

  function initGame(){
    if(!me) return;

    busy = false;

    excluded = new Set([me]);                // ç¬¬ä¸€è¼ªä¿è­·ï¼šæ’é™¤æˆ‘è‡ªå·±
    remaining = ALL_NAMES.filter(n => n !== me);
    history = [];

    // âœ… resetï¼šæ¯æ¬¡é–‹å§‹éƒ½è¦é‡ç½®ã€ŒåŠ å›æˆ‘è‡ªå·±ã€çš„æ——æ¨™
    meRestored = false;

    meName.textContent = me;
    remainCount.textContent = remaining.length;
    stateText.textContent = "å¾…æŠ½";

    reel1.textContent = "â€”";
    reel2.textContent = "â€”";
    reel3.textContent = "â€”";

    result.textContent = "æ‹‰æ¡¿é–‹å§‹æŠ½";
    status.textContent = "æç¤ºï¼šæŠŠå³é‚Šæ‹‰æ¡¿å¾€ä¸‹æ‹‰åˆ°åº•ï¼Œæ”¾é–‹å³å¯æŠ½ã€‚";

    reelsWrap.classList.remove("winFlash");
    marquee.classList.remove("winOn");

    renderHistory();
    renderExcluded();

    stepPickMe.style.display = "none";
    stepDraw.style.display = "block";

    // âœ… é–‹å§‹å¾Œæ‰å…è¨±æŠ½
    btnPull.disabled = false;

    setLever(0);
  }

  function renderHistory(){
    historyBox.innerHTML = "";
    if(history.length === 0){
      historyBox.innerHTML = `<div class="muted">ï¼ˆå°šæœªæŠ½å‡ºä»»ä½•äººï¼‰</div>`;
      return;
    }
    history.forEach((n, i) => {
      const div = document.createElement("div");
      div.innerHTML = `<b>#${i+1}</b>ã€€${n}`;
      historyBox.appendChild(div);
    });
  }

  function renderExcluded(){
    excludedBox.innerHTML = "";
    const arr = Array.from(excluded);
    if(arr.length === 0){
      excludedBox.innerHTML = `<div class="muted">ï¼ˆç›®å‰æ²’æœ‰æ’é™¤ï¼‰</div>`;
      return;
    }
    arr.forEach(n => {
      const div = document.createElement("div");
      div.innerHTML = (n === me) ? `ğŸ‘¤ <b>${n}</b>ï¼ˆæˆ‘è‡ªå·±ï¼‰` : `ğŸš« ${n}`;
      excludedBox.appendChild(div);
    });
  }

  function setLever(p){ // p: 0..1
    const track = leverTrack.getBoundingClientRect();
    const topPad = 12;
    const bottomPad = 12;
    const knobH = 88;
    const usable = track.height - topPad - bottomPad - knobH;

    const y = topPad + usable * p;
    leverKnob.style.top = y + "px";
    leverFill.style.height = Math.round(p * 100) + "%";
  }

  // ===== âœ… æŠ½ç±¤æ ¸å¿ƒï¼šç¬¬1è¼ªæ’é™¤ meï¼Œç¬¬2è¼ªé–‹å§‹å‰æŠŠ me åŠ å›ä¸€æ¬¡ =====
  function pickWinner(){
    if(remaining.length === 0) return null;

    // âœ… åªæœ‰ã€Œé–‹å§‹é¸çš„é‚£å€‹äºº(me)ã€æœƒè¢«åŠ å›ä¸€æ¬¡ï¼ˆåœ¨ç¬¬äºŒè¼ªé–‹å§‹å‰ï¼‰
    // æ¢ä»¶ï¼šæ­·å² >= 1 ä»£è¡¨ç¬¬ä¸€è¼ªå·²æŠ½å®Œï¼›ä¸”å°šæœªåŠ å›
    if(history.length >= 1 && !meRestored){
      if(!remaining.includes(me)){
        remaining.push(me);
      }
      excluded.delete(me);
      meRestored = true;
      remainCount.textContent = remaining.length;
    }

    // å®‰å…¨ä¿éšªï¼šé¿å…ç•°å¸¸ç‹€æ…‹æŠ½åˆ° undefined
    const idx = randInt(remaining.length);
    const picked = remaining.splice(idx, 1)[0];

    excluded.add(picked);
    history.push(picked);
    remainCount.textContent = remaining.length;

    return picked;
  }

  function startSpin(){
    ensureAudio();

    if(busy) return;
    if(remaining.length === 0){
      result.textContent = "âœ… å…¨éƒ¨éƒ½æŠ½å®Œäº†";
      status.textContent = "æ²’æœ‰å‰©é¤˜äººå“¡å¯ä»¥æŠ½ã€‚";
      stateText.textContent = "å®Œæˆ";
      return;
    }

    busy = true;
    stateText.textContent = "è½‰å‹•ä¸­";
    reelsWrap.classList.add("spinning");
    reelsWrap.classList.remove("winFlash");
    marquee.classList.remove("winOn");

    result.textContent = "ğŸ° è½‰å‹•ä¸­â€¦";
    status.textContent = "è«‹ç¨ç­‰ï¼Œæ­£åœ¨æŠ½ç±¤ï¼ˆRANDï¼‰";

    playPullSfx();
    haptic([10, 20, 10]);

    const poolForVisual = remaining.length ? remaining : ALL_NAMES.filter(n => n !== me);
    const getVisual = () => poolForVisual[randInt(poolForVisual.length)];

    const i1 = setInterval(()=>{ reel1.textContent = getVisual(); }, 60);
    const i2 = setInterval(()=>{ reel2.textContent = getVisual(); }, 70);
    const i3 = setInterval(()=>{ reel3.textContent = getVisual(); }, 80);

    // çœŸæ­£çš„ä¸­çè€…ï¼ˆRANDï¼‰
    const winner = pickWinner();

    setTimeout(()=>{
      clearInterval(i1);
      reel1.textContent = winner;
      playStopSfx(0);
      haptic(8);
    }, 850);

    setTimeout(()=>{
      clearInterval(i2);
      reel2.textContent = winner;
      playStopSfx(1);
      haptic(8);
    }, 1250);

    setTimeout(()=>{
      clearInterval(i3);
      reel3.textContent = winner;
      playStopSfx(2);
      haptic([12, 18, 12]);

      reelsWrap.classList.remove("spinning");

      reelsWrap.classList.add("winFlash");
      marquee.classList.add("winOn");
      playWinSfx();

      result.innerHTML = `ğŸ‰ æŠ½åˆ°ï¼š<span class="ok">${winner}</span>`;
      status.textContent = `å·²å°‡ã€Œ${winner}ã€æ’é™¤ï¼Œä¸‹ä¸€è¼ªä¸æœƒå†æŠ½åˆ°ã€‚`;

      renderHistory();
      renderExcluded();

      if(remaining.length === 0){
        stateText.textContent = "å®Œæˆ";
        status.textContent = "âœ… å·²æŠ½å®Œæ‰€æœ‰äººã€‚";
      }else{
        stateText.textContent = "å¾…æŠ½";
      }

      busy = false;
      setLever(0);
    }, 1650);
  }

  // ===== Lever drag (iPhone å‹å–„ï¼šç”¨æ‹–æ‹‰è·é›¢) =====
  let dragging = false;
  let startY = 0;
  let pull = 0; // 0..1

  function pointerY(e){
    if(e.touches && e.touches[0]) return e.touches[0].clientY;
    return e.clientY;
  }

  function onStart(e){
    if(busy) return;
    if(remaining.length === 0) return;

    ensureAudio();
    dragging = true;
    startY = pointerY(e);
    pull = 0;

    // âœ… é–é ï¼Œé¿å… iPhone èª¤æ»‘
    lockScroll();

    e.preventDefault();
  }

  function onMove(e){
    if(!dragging) return;

    const track = leverTrack.getBoundingClientRect();
    const currentY = pointerY(e);
    const delta = currentY - startY;

    const maxPull = track.height * 0.80;
    pull = Math.min(1, Math.max(0, delta / maxPull));

    setLever(pull);
    e.preventDefault();
  }

  function onEnd(){
    if(!dragging) return;
    dragging = false;

    if(pull >= 0.70){
      haptic([10, 20, 10]);
      startSpin();
    }else{
      playTone(220, 0.06, "sine", 0.05);
    }

    setLever(0);
    pull = 0;

    // âœ… æ”¾æ‰‹å›åˆ°åŸæœ¬ä½ç½®
    unlockScroll();
  }

  // âœ… æ•´æ¢æ‹‰æ¡¿éƒ½èƒ½æ‹‰ï¼ˆä¸æ˜¯åªæŠ“ knobï¼‰
  leverTrack.addEventListener("touchstart", onStart, {passive:false});
  leverTrack.addEventListener("touchmove", onMove, {passive:false});
  leverTrack.addEventListener("touchend", onEnd);

  leverTrack.addEventListener("mousedown", onStart);
  window.addEventListener("mousemove", onMove);
  window.addEventListener("mouseup", onEnd);

  // ===== Buttons =====
  btnStart.addEventListener("click", initGame);
  btnPull.addEventListener("click", startSpin);

  btnResetAll.addEventListener("click", () => {
    // ä¿éšªï¼šå¦‚æœå‰›å¥½é–é ï¼Œè§£æ‰
    unlockScroll();

    me = null;
    stepDraw.style.display = "none";
    stepPickMe.style.display = "block";
    btnStart.disabled = true;
    btnPull.disabled = true; // âœ… é‡ç½®å¾Œä¸èƒ½æŠ½
    pickHint.textContent = "è«‹å…ˆé¸ä¸€å€‹äººå";
    const radios = document.querySelectorAll('input[name="me"]');
    radios.forEach(r => r.checked = false);
  });

  // ===== init =====
  renderPickMe();
</script>
</body>
</html>

ç”¨é€™å€‹HTMLï¼Œå°‡å¾…æŠ½åå–®ç¨ç«‹åˆ—å‡ºä¾†ï¼ŒåŸä¾†çš„HTML ä¸è¦å‹•ï¼Œæ’å…¥å¾…æŠ½åå–®æ¸…å–®ï¼Œ
å°‡å¾…æŠ½åå–®+HTML åŸä¾†çš„æ•´ä½µ
